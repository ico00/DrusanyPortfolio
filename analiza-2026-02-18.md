# Detaljna analiza aplikacije Drusany Portfolio

**Datum:** 18. veljače 2026  
**Zadnje ažuriranje:** 19. veljače 2026  
**Autor:** Senior developer analiza  
**Verzija aplikacije:** Next.js 16.1.6, React 19.2.3

---

## 1. Pregled aplikacije

Drusany Portfolio je **statični fotografski portfolio** izgrađen na Next.js App Routeru. Cilj je proizvesti čisto statični HTML/JS/CSS output (`out/`) pogodan za hosting na bilo kojem statičnom hostingu (Vercel, Netlify, GitHub Pages).

**Ključne karakteristike:**
- Galerija s balanced masonry layoutom, kategorijama (Concerts, Sport, Animals, Interiors, Zagreb, Food & Drink)
- Hero slider na početnoj stranici
- Blog s BlockNote WYSIWYG editorom
- Lokalni admin panel (samo u development modu)
- Flat-file storage (JSON datoteke u `src/data/`)
- Statični export – nema servera u produkciji

---

## 2. DOBRE STRANE

### 2.1 Arhitektura i dizajn sustava

| Aspekt | Ocjena | Opis |
|-------|--------|------|
| **Jasna separacija** | ✅ Odlično | API rute, komponente, lib moduli i data sloj su logički odvojeni. |
| **Statični export** | ✅ Odlično | `output: "export"` omogućuje deploy na bilo koji statični hosting bez servera – nema troškova, nema održavanja backend-a. |
| **Flat-file baza** | ✅ Dobro | JSON datoteke su jednostavne, čitljive, verzionirane u gitu. Nema dependency na bazu podataka. |
| **Dokumentacija** | ✅ Odlično | `architecture.md` je izuzetno detaljan – opisuje API, strukturu podataka, design sustav, konvencije. |

### 2.2 Funkcionalnost

| Značajka | Opis |
|----------|------|
| **EXIF integracija** | Automatsko izvlačenje datuma, naslova, keywords, camera, lens, exposure, aperture, ISO iz slika pri uploadu. Fallback lanac za datum (DateTimeOriginal → CreateDate → DateTime → ModifyDate). |
| **Slug generiranje** | Jedinstveni slugovi po kategoriji, automatsko generiranje iz title+venue+year, "as you type" ažuriranje u adminu. |
| **Pretraga** | Filter-as-you-type u galeriji (title, alt, keywords, venue, sport) i na blogu (naslov, slug, kategorije, sadržaj). |
| **SEO modul** | Per-page SEO (metaTitle, metaDescription, keywords) za About, Contact i blog postove. Open Graph podrška. |
| **Theme prilagodba** | Font, veličina i boja po elementu (title, heading, body, quote, nav, caption) putem Admin → Theme. |
| **Content health** | Dashboard prikazuje slike bez EXIF-a, bez slug-a, blog postove bez featured slike – olakšava održavanje. |
| **BlockNote editor** | Rich text s uploadom slika u sadržaj, resize ručicama, poravnanjem. |

### 2.3 Pouzdanost (pozitivno)

| Aspekt | Opis |
|--------|------|
| **Graceful degradation** | `getPages()`, `getBlog()`, `getGear()`, `getPress()` vraćaju default vrijednosti pri grešci – aplikacija ne pada. |
| **Duplicate handling** | Upload API vraća 409 s opcijama (overwrite, addWithSuffix) umjesto da prebriše bez upozorenja. |
| **EXIF parse failure** | Ako exifr ne uspije parsirati, koriste se default vrijednosti – upload nastavlja. |
| **File existence checks** | `fileExists()` prije pisanja, provjera duplikata pri uploadu. |

### 2.4 Sigurnost (pozitivno)

| Aspekt | Opis |
|--------|------|
| **Admin samo u dev modu** | Sve API rute i `/admin` stranica provjeravaju `NODE_ENV !== "production"` i vraćaju 403 u produkciji. Admin se ne uključuje u statični build. |
| **Validacija tipa datoteke** | `ALLOWED_TYPES` (image/jpeg, image/png, image/webp, image/gif) provjerava se prije obrade. |
| **Sanitizacija imena** | `sanitizeFilename`, `sanitizeFolderName`, `slugify` – transliteracija hrvatskih dijakritika, uklanjanje specijalnih znakova, ograničenje duljine. |
| **Blog delete path check** | `blog-delete-file` provjerava da `url` počinje s `/uploads/blog/`. |
| **Sharp za slike** | Slike se uvijek reprocesiraju (resize, WebP) – smanjuje rizik od malicioznih slika (npr. polyglot). |

### 2.5 UX i performanse

| Aspekt | Opis |
|--------|------|
| **Balanced masonry** | Algoritam shortest-column-first – stupci približno jednake visine, minimalne praznine. |
| **Custom cursor** | Aperture ikona preko fotografija, dot s mix-blend-difference – premium dojam. |
| **Framer Motion** | Fade-in animacije, stagger, AnimatePresence za exit. |
| **Responsivnost** | `useColumnCount` – 1–4 stupca ovisno o viewportu. |
| **Lightbox** | EXIF toggle, URL sync (`?image=slug`), copyright zaštita (desni klik). |

### 2.6 Tech stack

- **Next.js 16** – App Router, SSG
- **Tailwind CSS 4** – utility-first
- **BlockNote** – block-based editor
- **Sharp** – image processing
- **exifr** – EXIF metadata
- **Recharts** – dashboard grafikoni
- **Formspree** – kontakt forma (vanjski servis)
- **sanitize-html** – HTML sanitizacija pri čitanju sadržaja
- **proper-lockfile** – file locking za JSON datoteke

### 2.7 Implementirana poboljšanja (veljača 2026)

| Kategorija | Implementacija | Datoteke |
|------------|----------------|----------|
| **Sigurnost** | Path traversal fix – provjera da rezolvirana putanja ostane unutar `public/uploads/blog/` | `blog-delete-file/route.ts` |
| **Sigurnost** | Ograničenje veličine uploada (20 MB) | `upload`, `blog-upload`, `exif-preview` |
| **Sigurnost** | HTML sanitizacija pri čitanju (getPages, getBlogPost) | `src/lib/sanitize.ts` |
| **Sigurnost** | Magic bytes provjera – file signature za JPEG/PNG/GIF/WebP | `src/lib/imageValidation.ts` |
| **Pouzdanost** | HTTP status 500 pri greškama (umjesto 200 s fallback) | `pages`, `blog`, `gallery`, `theme`, `content-health` |
| **Pouzdanost** | File locking za JSON (read-modify-write) | `src/lib/jsonLock.ts` |
| **Pouzdanost** | Čišćenje orphan datoteka pri promjeni slug-a/datuma blog posta | `src/lib/blogCleanup.ts` |
| **Funkcionalnost** | `.env.example` s `NEXT_PUBLIC_SITE_URL` | `.env.example` |
| **Funkcionalnost** | Zajednički EXIF modul | `src/lib/exif.ts` |
| **Funkcionalnost** | Validacija blog slug formata (`yymmdd-naslov`) | `src/lib/slug.ts`, blog API |
| **Funkcionalnost** | Uklonjen Instagram widget | `blogWidgets.json`, `BlogSidebar.tsx` |
| **Dodatno** | Rate limiting za admin API (60 req/min po IP) | `src/lib/rateLimit.ts` |
| **Dodatno** | Health check endpoint za CI/CD | `src/app/api/health/route.ts` |

**Ključne nove datoteke:** `sanitize.ts`, `imageValidation.ts`, `jsonLock.ts`, `exif.ts`, `blogCleanup.ts`, `slug.ts` (proširen), `rateLimit.ts`, `api/health/route.ts`

---

## 3. LOŠE STRANE

### 3.1 Sigurnost – preostali rizici

#### ~~3.1.1 Path traversal u `blog-delete-file`~~ ✅ POPRAVLJENO

Provjera rezolvirane putanje implementirana u `blog-delete-file/route.ts`.

#### 3.1.2 XSS preko `dangerouslySetInnerHTML` (srednji rizik)

**Lokacija:** `src/components/ProseContent.tsx`

**Problem:** HTML iz `pages.json` i `blog.json` (About, Contact, blog body) renderira se direktno s `dangerouslySetInnerHTML` bez sanitizacije. Sadržaj dolazi iz BlockNote editora – BlockNote ima vlastitu sanitizaciju, ali:

- Ako se JSON ikad ručno edita ili importa iz vanjskog izvora, može doći do XSS-a.
- Nema server-side sanitizacije pri spremanju.
- Nema DOMPurify ili slične biblioteke na klijentu.

**Status:** Djelomično – server-side sanitizacija pri čitanju (`sanitizeProseHtml` u `getPages`, `getBlogPost`). Klijentska sanitizacija pri renderiranju još nije dodana.

**Preporuka:** Za dodatnu zaštitu razmotriti DOMPurify na klijentu prije `dangerouslySetInnerHTML`.

#### ~~3.1.3 Nedostatak ograničenja veličine datoteke~~ ✅ POPRAVLJENO

Ograničenje 20 MB implementirano u `upload`, `blog-upload`, `exif-preview`.

#### 3.1.4 Formspree endpoint nije validiran (nizak rizik)

**Lokacija:** `pages.json` → `contact.formspreeEndpoint`

**Problem:** Admin može postaviti bilo koji URL. Ako netko dobije pristup adminu (dev modu), može preusmjeriti forme na svoj endpoint i uhvatiti poruke. S obzirom da je admin samo lokalno, rizik je nizak, ali vrijedi dokumentirati.

### 3.2 Pouzdanost – preostali problemi

#### ~~3.2.1 Skrivanje grešaka u API odgovorima~~ ✅ POPRAVLJENO

API rute (`pages`, `blog`, `gallery`, `theme`, `content-health`) vraćaju 500 pri grešci.

#### ~~3.2.2 Race condition pri simultanom pisanju JSON-a~~ ✅ POPRAVLJENO

File locking (`proper-lockfile`) implementiran za `gallery.json`, `blog.json`, `pages.json` u `src/lib/jsonLock.ts`.

#### ~~3.2.3 Orphan datoteke pri promjeni blog slug-a~~ ✅ POPRAVLJENO

`src/lib/blogCleanup.ts` – pri promjeni slug-a/datuma premješta uploads folder, ažurira URL-ove, briše stari `[slug].html`; pri brisanju posta briše folder i HTML.


### 3.3 Funkcionalnost – preostali nedostaci

| Problem | Status |
|---------|--------|
| ~~Nema `.env.example`~~ | ✅ Kreiran s `NEXT_PUBLIC_SITE_URL`, `RATE_LIMIT_*` |
| ~~Content type provjera samo po MIME~~ | ✅ Magic bytes provjera u `imageValidation.ts` |
| ~~Blog PUT – slug promjena~~ | ✅ `blogCleanup.ts` briše orphan datoteke |
| **Hero fallback** | Ako kategorija nema hero sliku, prikazuje se placeholder. Nema automatskog fallbacka na prvu/najnoviju sliku – dokumentirano, ali može zbuniti. |

### 3.4 Konzistentnost i održavanje

| Problem | Status |
|---------|--------|
| ~~Duplicirani EXIF kod~~ | ✅ Zajednički modul `src/lib/exif.ts` |
| **Mješoviti jezici** | Neke poruke na hrvatskom ("Samo u development modu", "url je obavezan"), neke na engleskom. |
| ~~Blog API – nedosljedan slug format~~ | ✅ Validacija i normalizacija u `slug.ts`, blog API koristi `normalizeBlogSlug` |

---

## 4. SIGURNOSNA ANALIZA – SAŽETAK

| Kategorija | Status | Napomena |
|------------|--------|----------|
| **Autentikacija** | N/A | Admin samo u dev modu – nema produkcijskog admina. |
| **Autorizacija** | ✅ | API zaštićen s `NODE_ENV` provjerom. |
| **Input validacija** | ✅ | File type OK, magic bytes, veličina 20 MB. Path traversal popravljen. |
| **XSS** | ⚠️ | Server-side sanitizacija pri čitanju (`sanitizeProseHtml`). Klijentska DOMPurify opcionalna. |
| **CSRF** | N/A | Forme idu na Formspree (vanjski). Admin je lokalni. |
| **Path traversal** | ✅ | Provjera rezolvirane putanje u `blog-delete-file`. |
| **File upload** | ✅ | Tip, magic bytes, veličina 20 MB. Sharp reprocesira. |
| **Secrets** | ✅ | `.env*` u gitignore. `.env.example` u repozitoriju. |
| **Rate limiting** | ✅ | 60 req/min po IP na admin API rutama. |

---

## 5. PREDLOZI POBOLJŠANJA

### 5.1 Implementirano (veljača 2026)

| # | Poboljšanje | Status |
|---|-------------|--------|
| 1 | Path traversal fix u `blog-delete-file` | ✅ |
| 2 | Ograničenje veličine uploada (20 MB) | ✅ |
| 3 | HTML sanitizacija (server-side) | ✅ |
| 4 | Magic bytes provjera | ✅ |
| 5 | Ispravni HTTP status kodovi (500) | ✅ |
| 6 | File locking za JSON | ✅ |
| 7 | Čišćenje orphan datoteka pri promjeni slug-a | ✅ |
| 8 | `.env.example` | ✅ |
| 9 | Zajednički EXIF modul | ✅ |
| 10 | Validacija blog slug formata | ✅ |
| 11 | Rate limiting | ✅ |
| 12 | Health check endpoint | ✅ |

### 5.2 Preostali predlozi

| # | Poboljšanje | Prioritet |
|---|-------------|-----------|
| 13 | **Konzistentni jezik poruka** – Odlučiti engleski ili hrvatski za sve API poruke i UI tekstove. | Srednji |
| 14 | **Backup skripta** – Jednostavna skripta koja arhivira `src/data/` i `public/uploads/` prije većih promjena. | Nizak |
| 15 | **Dodatna XSS zaštita** – DOMPurify na klijentu prije `dangerouslySetInnerHTML` (opcionalno). | Nizak |
| 16 | **Hero fallback** – Automatski fallback na prvu/najnoviju sliku ako kategorija nema hero. | Nizak |

---

## 6. ZAKLJUČAK

Drusany Portfolio je **dobro dizajnirana** aplikacija s jasnom arhitekturom, solidnom dokumentacijom i bogatim setom funkcionalnosti. Odluka za statični export i dev-only admin pametna je za ovaj use case – minimizira napadnu površinu u produkciji.

**Implementirana poboljšanja (veljača 2026):**
- Path traversal fix, ograničenje uploada (20 MB), magic bytes provjera
- HTML sanitizacija i file locking za JSON
- Čišćenje orphan datoteka pri promjeni blog slug-a
- Rate limiting, health check endpoint, validacija slug formata
- Zajednički EXIF modul, `.env.example`

**Preostali manji rizici:**
- XSS – djelomično zaštićen s server-side sanitizacijom; klijentska DOMPurify opcionalna
- Formspree endpoint nije validiran (nizak rizik, admin lokalni)

**Glavne prednosti:**
- Čista arhitektura i odlična dokumentacija
- EXIF integracija, SEO, theme prilagodba
- Graceful degradation i dobro razmišljen UX
- Širok set implementiranih sigurnosnih i pouzdanostnih poboljšanja

Aplikacija je spremna za dugoročno održavanje i eventualno proširenje (npr. produkcijski admin s autentikacijom).
